# -*- coding: utf-8 -*-

import requests


class CompletionExecutor:
    def __init__(self, host, api_key, request_id):
        self._host = host
        self._api_key = api_key
        self._request_id = request_id

    def execute(self, completion_request):
        headers = {
            'Authorization': self._api_key,
            'X-NCP-CLOVASTUDIO-REQUEST-ID': self._request_id,
            'Content-Type': 'application/json; charset=utf-8',
            'Accept': 'text/event-stream'
        }

        with requests.post(self._host + '/testapp/v1/chat-completions/HCX-003',
                           headers=headers, json=completion_request, stream=True) as r:
            for line in r.iter_lines():
                if line:
                    print(line.decode("utf-8"))


if __name__ == '__main__':
    completion_executor = CompletionExecutor(
        host='https://clovastudio.stream.ntruss.com',
        api_key='Bearer <api-key>',
        request_id=''
    )

    preset_text = [{"role":"system","content":"당신은 이커머스 로그 및 강화학습 모델의 출력을 바탕으로,\r\n각 상품별 최적 할인율(action1)과 추천 대상 유저 수(action2),\r\n그리고 예상 보상을 계산해주는 AI 어시스턴트입니다.\r\n\r\n사용자가 할인율이나 대상 유저 수를 달리 지정했을 때, \r\n1) 예상 판매 가격, \r\n2) 구매 전환율, \r\n3) 최종 보상 계산 근거, \r\n4) 전략 제안 \r\n등을 단계적으로 설명해주어야 합니다.\r\n\r\n답변 시:\r\n- 할인율과 가격, 대상 유저 수 등 숫자 데이터를 명확히 표시하세요.\r\n- '가격', '보상'은 화폐 단위를 의미하지 않기 때문에 특정 화폐 단위를 사용하지 않도록 합니다.\r\n- 즉, '원'과 같은 화폐 단위를 사용하지 않아야 합니다.\r\n- 계산 과정이나 추론 과정을 간략히 서술하여 이해를 돕습니다.\r\n- 전략 제안 시, 할인율 변경이 브랜드 가치와 이익률에 미치는 영향도 함께 고려하세요.\r\n- 지나치게 짧은 답변보다는 상세하고 구체적인 문장을 사용해주세요.\r\n"},{"role":"user","content":"아래는 제가 원하는 입력과 출력 형식 예시입니다.\r\n\r\n[예시 1 입력]\r\n- 상품 ID: 1\r\n- 현재 가격: 100\r\n- 브랜드 ID: 10\r\n- 카테고리 ID: 5\r\n추천된 최적 프로모션 값: 할인율 0.2, 추천 대상 유저 수 500, 최적 보상 100000\r\n사용자가 선택한 값: 할인율 0.15, 추천 대상 유저 수 300\r\n예상 보상: 80000\r\n\r\n[예시 1 출력]\r\n예상 보상 계산:\r\n- 할인율 15%를 적용하면 가격은 85\r\n- 추천 대상 유저 수 300명 시 전환율은 약 45%로 추정\r\n- 최종 보상은 매출 증가분에서 할인 비용을 뺀 금액으로 80000 정도\r\n\r\n전략 제안:\r\n- 할인율을 20%로 다시 높이면 판매량이 추가 상승하며 100000 달성 가능\r\n- 타겟 유저도 500명 이상으로 확장 시 매출 증대\r\n\r\n[예시 2 입력]\r\n- 상품 ID: 11\r\n- 현재 가격: 800\r\n- 브랜드 ID: 101\r\n- 카테고리 ID: 55\r\n추천된 최적 프로모션 값: 할인율 0.2, 추천 대상 유저 수 500, 최적 보상 100000\r\n사용자가 선택한 값: 할인율 0.05, 추천 대상 유저 수 100\r\n예상 보상: 20000\r\n\r\n[예시 2 출력]\r\n예상 보상 계산:\r\n- 할인율이 5%로 낮아 판매가는 760\r\n- 타겟 유저 100명이라 노출이 제한되어 전환 효과가 작음\r\n- 예측 보상은 약 20000\r\n\r\n전략 제안:\r\n- 현재 선택안은 마케팅 효과가 미미\r\n- 할인율 20% 유지 + 500명 노출 시 보상 100000 달성\r\n- 혹은 할인율 15%로 절충하여 수익성과 판매량 균형 추구\r\n\r\n[새로운 입력]\r\n- 상품 ID: 25\r\n- 현재 가격: 500\r\n- 브랜드 ID: 200\r\n- 카테고리 ID: 80\r\n추천된 최적 프로모션 값: 할인율 0.1, 추천 대상 유저 수 300, 최적 보상 60000\r\n사용자가 선택한 값: 할인율 0.2, 추천 대상 유저 수 500\r\n예상 보상: 120000\r\n\r\n[요청]\r\n예시 출력과 같은 구조로\r\n1) 예상 보상 계산\r\n2) 전략 제안\r\n을 단계별로 구체적으로 설명해주세요.\n\n[조건]\n- 가격은 특정 화폐 단위를 의미하지 않음\n- 보상도 특정 화폐 단위가 아님\n- 답변 시 가격 및 보상과 관련하여 특정 화폐 단위를 나타내지 않도록 주의"},{"role":"assistant","content":"예상 보상 계산:\n- 사용자가 선택한 할인율 20%를 적용하면 가격은 400\n- 추천 대상 유저 수 500명 시 전환율은 약 60%로 추정\n- 최종 보상은 매출 증가분에서 할인 비용을 뺀 금액으로 120000 정도\n\n전략 제안:\n- 높은 할인율에도 불구하고 더 많은 유저에게 노출되므로 충분한 판매량 확보 기대\n- 다만 지나친 할인율은 브랜드 이미지 하락 초래 가능성 있으므로 모니터링 필요\n- 동시에 다른 마케팅 채널 활용 또는 교차 판매 유도 통해 추가 수입 창출 방안 검토"},{"role":"user","content":"[예시 3 입력]\n- 상품 ID: 15\n- 현재 가격: 250\n- 브랜드 ID: 35\n- 카테고리 ID: 12\n추천된 최적 프로모션 값: 할인율 0.15, 추천 대상 유저 수 400, 최적 보상 70000\n사용자가 선택한 값: 할인율 0.25, 추천 대상 유저 수 400\n예상 보상: 85000\n\n[예시 3 출력]\n예상 보상 계산:\n1) 할인율 25%를 적용하면, 판매가격은 250 × (1 - 0.25) = 187.5로 조정됩니다.\n2) 추천 대상 유저 수는 400명으로 동일하므로, 구매 전환율은 기존 대비 약간 더 상승할 것으로 예상됩니다.\n3) 따라서 할인율 상승에 따른 비용 부담을 감안하더라도, 전환율 증가로 인한 매출 증대 효과가 커져\n   최종 보상은 약 85000 수준에 이를 것으로 보입니다.\n\n전략 제안:\n1) **공격적 할인율**: 할인율을 25%로 높였으므로, 브랜드 이미지와 단가 이익이 감소할 수 있습니다. \n   만약 브랜드 가치 유지가 중요하다면 20% 정도로 절충해 보는 것도 방법입니다.\n2) **타겟 400명 고정**: 추천 대상 유저 수를 400명 그대로 유지한다면, 할인율 상승 효과가 어느 정도 한계에 부딪힐 수 있습니다.\n   추가 예산이 허용된다면, 타겟 유저 범위를 500명 이상으로 늘려 매출 극대화를 노려볼 만합니다.\n3) **재고·물류 관리**: 할인율이 높아지면 단기적으로 주문량이 예측을 뛰어넘을 수 있으므로, 재고 확보와 물류비용 최적화 전략이 필수적입니다.\n\n[예시 4 입력]\n- 상품 ID: 19\n- 현재 가격: 150\n- 브랜드 ID: 45\n- 카테고리 ID: 15\n추천된 최적 프로모션 값: 할인율 0.2, 추천 대상 유저 수 600, 최적 보상 90000\n사용자가 선택한 값: 할인율 0.05, 추천 대상 유저 수 150\n예상 보상: 30000\n\n[예시 4 출력]\n예상 보상 계산:\n1) 할인율을 5%로 낮추면, 판매가격은 150 × (1 - 0.05) = 142.5가 됩니다.\n2) 추천 대상 유저 수도 150명으로 크게 줄어, 구매 전환율이나 총판매량 증가 폭이 제한적입니다.\n3) 결과적으로 예상 보상은 대략 30000 정도에 머무를 것으로 추정되며, 이는 본래 추천된 최적 보상(90000)과 큰 차이를 보입니다.\n\n전략 제안:\n1) **할인 폭 최소화의 효과**: 할인율이 낮으니 마진율 자체는 좋지만, 판매량 증대 효과가 작아 전체 보상 규모가 제한적입니다.\n2) **노출 범위 재검토**: 타겟 유저 수를 150명으로 설정한 것은 안전하지만, 프로모션 효과가 거의 체감되지 않을 수 있습니다.\n   적어도 300~400명 이상을 확보하면 보상을 높일 가능성이 커집니다.\n3) **균형 잡힌 할인율**: 5% 수준으로는 프로모션 효과가 미미할 수 있으니, 10%나 15% 정도로 재조정해 판매와 수익 간 균형을 모색하는 것이 좋습니다.\n\n[새로운 입력]\r\n- 상품 ID: 111029\r\n- 현재 가격: 5523\r\n- 브랜드 ID: 21254\r\n- 카테고리 ID: 8124\r\n추천된 최적 프로모션 값: 할인율 0.15, 추천 대상 유저 수 3000, 최적 보상 728\r\n사용자가 선택한 값: 할인율 0.2, 추천 대상 유저 수 7000\r\n예상 보상: 127\r\n\r\n[요청]\r\n예시 출력과 같은 구조로\r\n1) 예상 보상 계산\r\n2) 전략 제안\r\n을 단계별로 구체적으로 설명해주세요.\n"},{"role":"assistant","content":"예상 보상 계산:\n1) 먼저 사용자가 선택한 할인율 20%를 적용하면, 판매가격은 5523 * (1 - 0.2) = 4418.4로 조정됩니다.\n2) 다음으로 추천 대상 유저 수를 7000명으로 늘리면, 구매 전환율 역시 대폭 상승할 것으로 가정할 수 있습니다.\n3) 하지만 두 가지 변화 모두 비용 증가를 동반하기 때문에, 최종 보상은 127 정도로 예상됩니다.\n\n전략 제안:\n1)**높은 할인율** : 20%라는 높은 할인율은 고객 유인에는 유리하지만, 그만큼 브랜드 이미지나 제품 단가는 희생될 수밖에 없습니다. 상황에 따라 15% 정도로 타협하는 것도 고려해 볼 만합니다.\n2)**대규모 광고 캠페인**: 대규모 유저 풀을 대상으로 하는 만큼, 효율적인 광고 캠페인 설계와 실행이 매우 중요합니다. 다양한 채널과 기법을 활용해 최대한 많은 트래픽을 끌어들이고, 전환율을 높이는 데 집중해야 합니다.\n3)**고객 서비스 강화**: 대량주문 처리과정에서 발생할 수 있는 문제들을 미리 예측하고, 적극적으로 대응할 수 있는 체계를 마련해야 합니다. 또한 고객 만족도를 높이기 위해 빠르고 정확한 피드백 시스템 구축도 필수입니다."},{"role":"user","content":"[새로운 입력]\r\n- 상품 ID: 123\r\n- 현재 가격: 6654\r\n- 브랜드 ID: 5544\r\n- 카테고리 ID: 234\r\n추천된 최적 프로모션 값: 할인율 0.05, 추천 대상 유저 수 1000, 최적 보상 5643\r\n사용자가 선택한 값: 할인율 0.15, 추천 대상 유저 수 850\r\n예상 보상: 5000"},{"role":"assistant","content":"예상 보상 계산:\n1) 사용자가 선택한 할인율 15%를 적용하면, 판매가격은 6654 * (1 - 0.15) = 5698.1로 조정됩니다.\n2) 추천 대상 유저 수를 850명으로 줄이면, 구매 전환율은 다소 감소할 것으로 예상됩니다.\n3) 이러한 변화를 종합적으로 고려할 때, 최종 예상 보상은 5000 내외일 것으로 판단됩니다.\n\n전략 제안:\n1)**할인율 확대**: 비록 추천된 최적값보다 할인율이 높지만, 이로 인해 판매량이 늘어나면 보상도 증가할 가능성이 높습니다. 더불어 경쟁사와의 차별화 요소로도 작용할 수 있어 긍정적 효과를 기대할 수 있습니다.\n2)**타겟 유저 축소**: 상대적으로 적은 수의 유저를 대상으로 하므로, 보다 정밀한 타기팅과 맞춤형 마케팅 전략이 필요합니다. 예를 들어 유사한 취향이나 행동 패턴을 가진 유저 그룹을 선별하거나, 개인화된 메시지나 추천 기능을 활용하는 식입니다.\n3)**프로모션 기간 설정**: 일정 기간 동안만 진행되는 이벤트 형태로 구성함으로써, 유저들의 참여 동기를 높이고 홍보 효과를 극대화할 수 있습니다. 이때 적절한 타이밍과 공지 방식을 고민해야 하며, 종료 후에는 성과 분석과 피드백을 통해 개선점을 도출해야 합니다."},{"role":"user","content":"[새로운 입력]\r\n- 상품 ID: 665\r\n- 현재 가격: 5463\r\n- 브랜드 ID: 123\r\n- 카테고리 ID: 4\r\n추천된 최적 프로모션 값: 할인율 0.00, 추천 대상 유저 수 4000, 최적 보상 2654\r\n사용자가 선택한 값: 할인율 0.15, 추천 대상 유저 수 5000\r\n예상 보상: 1233"},{"role":"assistant","content":"예상 보상 계산:\n1) 사용자가 선택한 할인율 15%를 적용하면, 판매가격은 5463 * (1 - 0.15) = 4677.45로 조정됩니다.\n2) 추천 대상 유저 수를 5000명으로 늘리면, 구매 전환율은 소폭 상승할 것으로 예상됩니다.\n3) 위 사항을 종합적으로 고려하였을 때, 최종 예상 보상은 1233정도 일 것으로 판단됩니다.  \n\n전략 제안 :\n1.**할인율 변동**: 초기 추천되었던 할인율인 0%에서 15%로 변동 하였을 때, 소비자들이 해당 상품에 대해 더욱 매력을 느낄 수 있을 것 입니다. 그러나 할인율이 커질수록 기업 입장에서는 손해가 발생 할 수 있기 때문에 적절한 할인율을 찾는 것이 중요합니다.\n   \n2.**광고대상 확대**: 추천 대상 유저 수를 4000명에서 5000명으로 확대 함으로서, 광고의 도달 범위를 넓히고, 그로 인해 잠재적 구매자를 늘릴 수 있습니다. 이렇게 광고 대상을 확대 했을 때, 광고비 지출 또한 늘어날 수 있기 때문에 그에 맞는 예산 설정이 필요합니다.   \n\n3.**프로모션 기획**: 단순히 광고를 통한 유입 뿐만 아니라, 다양한 프로모션을 기획하여 소비자들의 구매 욕구를 자극 할 수 있습니다. 예를 들면 일정 기간동안 무료 배송 이벤트를 진행 한다거나, 첫 구매 고객에게 할인 쿠폰을 제공하는 등의 프로모션을 기획 해 볼 수 있습니다."},{"role":"user","content":"[새로운 입력]\r\n- 상품 ID: 900\r\n- 현재 가격: 5400\r\n- 브랜드 ID: 200\r\n- 카테고리 ID: 45\r\n추천된 최적 프로모션 값: 할인율 0.10, 추천 대상 유저 수 200, 최적 보상 3000\r\n사용자가 선택한 값: 할인율 0.10, 추천 대상 유저 수 200\r\n예상 보상: 3000"},{"role":"assistant","content":"예상 보상 계산:\n1) 사용자가 선택한 할인율 10% 와 추천 대상 유저 수 200명이 최적 프로모션 값과 동일 하기 때문에 예상 보상도 3000으로 동일합니다.\n\n전략 제안:\n1.최적 프로모션 값을 선택하였기 때문에 따로 전략을 제안할 필요는 없지만, 혹시라도 추천 대상 유저수를 늘리거나 줄이고 싶을 경우엔 그에 맞는 예산과 목표치를 수정하여 전략을 짜야 합니다. 그리고 할인율을 다르게 설정하고 싶을 경우에도 마찬가지로 여러가지 상황을 고려하여 결정해야 합니다."}]

    request_data = {
        'messages': preset_text,
        'topP': 0.8,
        'topK': 0,
        'maxTokens': 2071,
        'temperature': 0.5,
        'repeatPenalty': 5.0,
        'stopBefore': [],
        'includeAiFilters': False,
        'seed': 0
    }

    # print(preset_text)
    completion_executor.execute(request_data)
